{% extends 'base.html' %}

{% block content %}
<div class="flex flex-col gap-8">
  <div class="flex flex-col justify-between gap-6 sm:flex-row sm:items-end">
    <div class="flex flex-col gap-2">
      <h1 class="text-3xl font-bold tracking-tight text-slate-900">Bordro ve Maaş Hesaplama</h1>
      <p class="text-slate-500">Personel maaşlarını, mesai ve ödemeleri yönetin.</p>
    </div>
    <div class="flex items-center gap-3">
      <div class="flex flex-col">
        <span class="mb-1.5 text-xs font-medium uppercase text-slate-500">Dönem</span>
        <div class="flex gap-2">
          <div class="relative">
            <select id="periodMonth" onchange="updatePeriod()"
              class="h-11 w-32 appearance-none rounded-xl border-slate-200 bg-white px-4 py-2 pr-10 text-sm font-medium shadow-sm outline-none focus:border-primary focus:ring-1 focus:ring-primary">
              {% set months_tr = ["Ocak", "Şubat", "Mart", "Nisan", "Mayıs", "Haziran", "Temmuz", "Ağustos", "Eylül",
              "Ekim", "Kasım", "Aralık"] %}
              {% for i in range(1, 13) %}
              <option value="{{ i }}" {% if i==current_month %}selected{% endif %}>{{ months_tr[i-1] }}</option>
              {% endfor %}
            </select>
            <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-slate-500">
              <span class="material-symbols-outlined text-sm">expand_more</span>
            </div>
          </div>
          <div class="relative">
            <select id="periodYear" onchange="updatePeriod()"
              class="h-11 w-28 appearance-none rounded-xl border-slate-200 bg-white px-4 py-2 pr-10 text-sm font-medium shadow-sm outline-none focus:border-primary focus:ring-1 focus:ring-primary">
              {% for y in years %}
              <option value="{{ y }}" {% if y==current_year %}selected{% endif %}>{{ y }}</option>
              {% endfor %}
            </select>
            <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-slate-500">
              <span class="material-symbols-outlined text-sm">expand_more</span>
            </div>
          </div>
        </div>
      </div>
      <button onclick="window.print()"
        class="mt-auto flex h-11 items-center gap-2 rounded-xl border border-slate-200 bg-white px-4 text-sm font-medium text-slate-700 shadow-sm hover:bg-slate-50 transition-colors">
        <span class="material-symbols-outlined text-lg">print</span>
        Yazdır
      </button>
    </div>
  </div>

  <div class="grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-4">
    <div class="relative overflow-hidden rounded-2xl bg-white p-6 shadow-sm border border-slate-100">
      <dt class="truncate text-sm font-medium text-slate-500">Toplam Personel</dt>
      <dd class="mt-2 text-3xl font-bold text-slate-900">
        {{ results|length }}
      </dd>
      <div class="absolute right-4 top-4 rounded-full bg-blue-50 p-2 text-blue-600">
        <span class="material-symbols-outlined">group</span>
      </div>
    </div>
    <div class="relative overflow-hidden rounded-2xl bg-white p-6 shadow-sm border border-slate-100">
      <dt class="truncate text-sm font-medium text-slate-500">Hesaplanan Bordro</dt>
      <dd class="mt-2 text-3xl font-bold text-slate-900">
        {{ results|length }}
      </dd>
      <div class="absolute right-4 top-4 rounded-full bg-green-50 p-2 text-green-600">
        <span class="material-symbols-outlined">assignment_turned_in</span>
      </div>
    </div>
    <div class="relative overflow-hidden rounded-2xl bg-white p-6 shadow-sm border border-slate-100">
      <dt class="truncate text-sm font-medium text-slate-500">Toplam Mesai Saati</dt>
      <dd class="mt-2 text-3xl font-bold text-slate-900">
        {{ "%.0f"|format(results|sum(attribute='overtime_hours') if results else 0) }}s
      </dd>
      <div class="absolute right-4 top-4 rounded-full bg-amber-50 p-2 text-amber-600">
        <span class="material-symbols-outlined">schedule</span>
      </div>
    </div>
    <div class="relative overflow-hidden rounded-2xl bg-white p-6 shadow-sm border border-slate-100">
      <dt class="truncate text-sm font-medium text-slate-500">Ödenecek Toplam Tutar</dt>
      <dd class="mt-2 text-3xl font-bold text-primary">
        ₺{{ '{:,.2f}'.format(results|sum(attribute='payroll') if results else 0) }}
      </dd>
      <div class="absolute right-4 top-4 rounded-full bg-indigo-50 p-2 text-primary">
        <span class="material-symbols-outlined">payments</span>
      </div>
    </div>
  </div>

  <div class="overflow-hidden rounded-2xl border border-slate-200 bg-white shadow-sm">
    <div class="overflow-x-auto">
      <table class="w-full text-left text-sm">
        <thead class="border-b border-slate-200 bg-slate-50">
          <tr>
            <th class="px-4 py-4 font-semibold text-slate-600">Personel Adı</th>
            <th class="px-4 py-4 font-semibold text-slate-600" scope="col">Departman</th>
            <th class="px-3 py-4 font-semibold text-slate-600 text-right">Baz Maaş</th>
            <th class="px-3 py-4 font-semibold text-slate-600 text-center">Toplam Saat</th>
            <th class="px-3 py-4 font-semibold text-slate-600 text-center">Mesai</th>
            <th class="px-3 py-4 font-semibold text-slate-600 text-right">Mesai Ücreti</th>
            <th class="px-3 py-4 font-semibold text-slate-600 text-right">Kesintiler</th>
            <th class="px-3 py-4 font-bold text-primary text-right whitespace-nowrap">Ödenecek Tutar</th>
            <th class="px-3 py-4 font-semibold text-slate-600 text-center">Durum</th>
            <th class="px-3 py-4 text-right">İşlemler</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-slate-200">
          {% for r in results %}
          <tr class="group hover:bg-slate-50 transition-colors">
            <td class="px-4 py-4">
              <div class="flex items-center gap-3">
                <div
                  class="h-9 w-9 shrink-0 overflow-hidden rounded-full bg-slate-200 flex items-center justify-center text-sm font-semibold text-slate-700">
                  {{ r.name[0] if r.name }}
                </div>
                <div class="min-w-0">
                  <div class="font-medium text-slate-900 truncate">{{ r.name }}</div>
                  <div class="text-[10px] text-slate-500">ID: #{{ r.personel_id }}</div>
                </div>
              </div>
            </td>
            <td class="px-4 py-4 text-slate-600">
              {{ r.department if r.department is defined else 'Genel' }}
            </td>
            <td class="px-3 py-4 text-right font-medium text-slate-700 whitespace-nowrap">
              ₺{{ '{:,.2f}'.format(r.net_salary or 0) }}
            </td>
            <td class="px-3 py-4 text-center">
              <span
                class="inline-flex items-center rounded-md bg-slate-50 px-1.5 py-0.5 text-xs font-medium text-slate-600 ring-1 ring-inset ring-slate-500/10">
                {{ "%.1f"|format(r.total_work_hours or 0) }}s
              </span>
            </td>
            <td class="px-3 py-4 text-center">
              <span
                class="inline-flex items-center rounded-md bg-blue-50 px-1.5 py-0.5 text-xs font-medium text-blue-700 ring-1 ring-inset ring-blue-700/10">
                {{ "%.0f"|format(r.overtime_hours or 0) }}s
              </span>
            </td>
            <td class="px-3 py-4 text-right text-slate-600 whitespace-nowrap">
              ₺{{ '{:,.2f}'.format(r.overtime_pay or 0) }}
            </td>
            <td class="px-3 py-4 text-right text-red-500 whitespace-nowrap">
              ₺{{ '{:,.2f}'.format(r.deductions or 0) }}
            </td>
            <td class="px-3 py-4 text-right font-bold text-primary text-sm whitespace-nowrap">
              ₺{{ '{:,.2f}'.format(r.payroll or 0) }}
            </td>
            <td class="px-3 py-4 text-center">
              {% if r.is_paid %}
              <span
                class="inline-flex items-center rounded-full bg-green-50 px-2 py-0.5 text-xs font-medium text-green-700 ring-1 ring-inset ring-green-600/20">
                <span class="material-symbols-outlined text-[14px] mr-1">check_circle</span>
                Ödendi
              </span>
              {% else %}
              <span
                class="inline-flex items-center rounded-full bg-amber-50 px-2 py-0.5 text-xs font-medium text-amber-700 ring-1 ring-inset ring-amber-600/20">
                <span class="material-symbols-outlined text-[14px] mr-1">pending</span>
                Hesaplandı
              </span>
              {% endif %}
            </td>
            <td class="px-3 py-4 text-right">
              <div class="flex items-center justify-end gap-0.5">
                {% if not r.is_paid %}
                <button onclick="confirmPayment('{{ r.personel_id }}', '{{ r.name }}', '{{ r.payroll }}')"
                  class="flex items-center gap-1 px-2 py-1 bg-primary/10 text-primary text-[11px] font-bold rounded-lg hover:bg-primary hover:text-white transition-all shadow-sm group"
                  title="Maaş Öde">
                  <span class="material-symbols-outlined text-[16px]">payments</span>
                  <span>Öde</span>
                </button>
                {% endif %}

                <a href="/personel/{{ r.personel_id }}/edit"
                  class="size-7 inline-flex items-center justify-center rounded-lg text-slate-400 hover:bg-slate-100 hover:text-slate-700 transition-all"
                  title="Personel Kartı">
                  <span class="material-symbols-outlined text-[18px]">person</span>
                </a>

                <a href="/puantaj?personel_id={{ r.personel_id }}"
                  class="size-7 inline-flex items-center justify-center rounded-lg text-slate-400 hover:bg-slate-100 hover:text-slate-700 transition-all"
                  title="Puantaj Detayı">
                  <span class="material-symbols-outlined text-[18px]">calendar_month</span>
                </a>

                <a href="/bordro/{{ r.personel_id }}/send_email?month={{ current_month }}&year={{ current_year }}"
                  class="size-7 inline-flex items-center justify-center rounded-lg text-slate-400 hover:bg-blue-50 hover:text-blue-600 transition-all"
                  title="E-posta ile Gönder">
                  <span class="material-symbols-outlined text-[18px]">mail</span>
                </a>

                <a href="/bordro/whatsapp?phone={{ r.phone }}&message=Sayın {{ r.name }}, {{ current_month }}/{{ current_year }} dönemine ait maaş bordronuz hazırlanmıştır. Ödenecek net tutar: {{ '{:,.2f}'.format(r.payroll) }} TL."
                  target="_blank"
                  class="size-7 inline-flex items-center justify-center rounded-lg text-slate-400 hover:bg-green-50 hover:text-green-600 transition-all"
                  title="WhatsApp ile Gönder">
                  <span class="material-symbols-outlined text-[18px]">chat</span>
                </a>

                <a href="/bordro/{{ r.personel_id }}/pusula"
                  class="size-7 inline-flex items-center justify-center rounded-lg text-blue-500 hover:bg-blue-50 transition-all"
                  title="Bordro Yazdır / PDF">
                  <span class="material-symbols-outlined text-[18px]">print</span>
                </a>
              </div>
            </td>
          </tr>
          {% else %}
          <tr>
            <td colspan="10" class="px-6 py-6 text-center text-sm text-slate-500">
              Bu ay için bordro kaydı bulunamadı.
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Payment Confirmation Modal -->
<div id="paymentModal"
  class="hidden fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-[100] flex items-center justify-center p-4">
  <div class="bg-white rounded-2xl shadow-2xl max-w-lg w-full overflow-hidden transform transition-all">
    <div class="p-6">
      <div class="flex items-center justify-between mb-6">
        <div class="flex items-center gap-4">
          <div class="w-12 h-12 rounded-full bg-primary/10 flex items-center justify-center text-primary">
            <span class="material-symbols-outlined text-2xl">payments</span>
          </div>
          <div>
            <h3 class="text-xl font-bold text-slate-900">Maaş Ödemesi</h3>
            <p class="text-xs text-slate-500">Ödeme yöntemini ve detaylarını seçiniz.</p>
          </div>
        </div>
        <button onclick="closePaymentModal()"
          class="p-2 hover:bg-slate-100 rounded-full text-slate-400 transition-colors">
          <span class="material-symbols-outlined">close</span>
        </button>
      </div>

      <div class="space-y-4 py-4 border-y border-slate-100 mb-6">
        <div class="flex justify-between">
          <span class="text-slate-500">Personel:</span>
          <span id="modalPersonName" class="font-semibold text-slate-900">-</span>
        </div>
        <div class="flex justify-between text-lg">
          <span class="text-slate-900 font-medium">Toplam Maaş:</span>
          <span id="modalAmount" class="font-bold text-primary">₺0.00</span>
        </div>
      </div>

      <form id="paymentForm" action="/bordro/pay" method="POST" class="space-y-5">
        <input type="hidden" name="personel_id" id="modalPersonId">
        <input type="hidden" name="amount" id="modalAmountInput">
        <input type="hidden" name="month" value="{{ current_month }}">
        <input type="hidden" name="year" value="{{ current_year }}">

        <div>
          <label class="block text-sm font-semibold text-slate-700 mb-2">Ödeme Yöntemi</label>
          <div class="grid grid-cols-3 gap-3">
            <label
              class="relative flex flex-col items-center gap-2 p-3 rounded-xl border border-slate-200 cursor-pointer hover:bg-slate-50 transition-all [&:has(input:checked)]:border-primary [&:has(input:checked)]:bg-primary/5">
              <input type="radio" name="payment_method" value="cash" class="sr-only" onchange="togglePaymentInputs()"
                checked>
              <span class="material-symbols-outlined text-xl text-slate-400">payments</span>
              <span class="text-xs font-bold text-slate-600">Nakit</span>
            </label>
            <label
              class="relative flex flex-col items-center gap-2 p-3 rounded-xl border border-slate-200 cursor-pointer hover:bg-slate-50 transition-all [&:has(input:checked)]:border-primary [&:has(input:checked)]:bg-primary/5">
              <input type="radio" name="payment_method" value="bank" class="sr-only" onchange="togglePaymentInputs()">
              <span class="material-symbols-outlined text-xl text-slate-400">account_balance</span>
              <span class="text-xs font-bold text-slate-600">Banka</span>
            </label>
            <label
              class="relative flex flex-col items-center gap-2 p-3 rounded-xl border border-slate-200 cursor-pointer hover:bg-slate-50 transition-all [&:has(input:checked)]:border-primary [&:has(input:checked)]:bg-primary/5">
              <input type="radio" name="payment_method" value="mixed" class="sr-only" onchange="togglePaymentInputs()">
              <span class="material-symbols-outlined text-xl text-slate-400">shuffle</span>
              <span class="text-xs font-bold text-slate-600">Karma</span>
            </label>
          </div>
        </div>

        <div id="bankSection" class="hidden space-y-2">
          <label class="block text-sm font-semibold text-slate-700">Banka Hesabı</label>
          <select name="bank_id"
            class="w-full h-11 rounded-xl border-slate-200 bg-white text-sm focus:ring-primary focus:border-primary">
            {% for b in banks %}
            <option value="{{ b.BankaID }}">{{ b.BankaAdi }} - {{ b.HesapAdi }}</option>
            {% endfor %}
          </select>
        </div>

        <div id="mixedSection" class="hidden grid grid-cols-2 gap-4">
          <div class="space-y-2">
            <label class="block text-sm font-semibold text-slate-700">Nakit Tutar</label>
            <div class="relative">
              <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-sm">₺</span>
              <input type="number" step="0.01" name="mixed_cash_amount" id="mixedCash"
                oninput="syncMixedVolumes('cash')"
                class="w-full h-11 pl-7 rounded-xl border-slate-200 bg-white text-sm focus:ring-primary focus:border-primary">
            </div>
          </div>
          <div class="space-y-2">
            <label class="block text-sm font-semibold text-slate-700">Banka Tutar</label>
            <div class="relative">
              <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-sm">₺</span>
              <input type="number" step="0.01" name="mixed_bank_amount" id="mixedBank"
                oninput="syncMixedVolumes('bank')"
                class="w-full h-11 pl-7 rounded-xl border-slate-200 bg-white text-sm focus:ring-primary focus:border-primary">
            </div>
          </div>
        </div>

        <div class="flex gap-3 pt-4 border-t border-slate-100">
          <button type="button" onclick="closePaymentModal()"
            class="flex-1 px-4 py-3 rounded-xl border border-slate-200 text-slate-600 font-bold hover:bg-slate-50 transition-colors">
            İptal
          </button>
          <button type="submit"
            class="flex-1 px-4 py-3 rounded-xl bg-primary text-white font-bold hover:bg-blue-700 transition shadow-lg shadow-primary/20">
            Ödemeyi Tamamla
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  function updatePeriod() {
    const month = document.getElementById('periodMonth').value;
    const year = document.getElementById('periodYear').value;
    window.location.href = `/bordro?month=${month}&year=${year}`;
  }

  function togglePaymentInputs() {
    const methodEl = document.querySelector('input[name="payment_method"]:checked');
    const method = methodEl ? methodEl.value : 'cash';
    const bankSection = document.getElementById('bankSection');
    const mixedSection = document.getElementById('mixedSection');

    bankSection.classList.toggle('hidden', method === 'cash');
    mixedSection.classList.toggle('hidden', method !== 'mixed');

    if (method === 'mixed') {
      const total = parseFloat(document.getElementById('modalAmountInput').value);
      document.getElementById('mixedCash').value = (total / 2).toFixed(2);
      document.getElementById('mixedBank').value = (total / 2).toFixed(2);
    }
  }

  function syncMixedVolumes(source) {
    const total = parseFloat(document.getElementById('modalAmountInput').value);
    const cashInput = document.getElementById('mixedCash');
    const bankInput = document.getElementById('mixedBank');

    if (source === 'cash') {
      const cashVal = parseFloat(cashInput.value) || 0;
      bankInput.value = Math.max(0, total - cashVal).toFixed(2);
    } else {
      const bankVal = parseFloat(bankInput.value) || 0;
      cashInput.value = Math.max(0, total - bankVal).toFixed(2);
    }
  }

  function confirmPayment(id, name, amount) {
    document.getElementById('modalPersonId').value = id;
    document.getElementById('modalPersonName').innerText = name;
    document.getElementById('modalAmount').innerText = '₺' + parseFloat(amount).toLocaleString('tr-TR', { minimumFractionDigits: 2 });
    document.getElementById('modalAmountInput').value = amount;

    // Reset modal state
    const cashRadio = document.querySelector('input[name="payment_method"][value="cash"]');
    if (cashRadio) cashRadio.checked = true;
    togglePaymentInputs();

    document.getElementById('paymentModal').classList.remove('hidden');
  }

  function closePaymentModal() {
    document.getElementById('paymentModal').classList.add('hidden');
  }

  function toggleMenu(id) {
    if (window.event) event.stopPropagation();
    const menu = document.getElementById(id);
    if (!menu) return;
    const allMenus = document.querySelectorAll('[id^="menu-"]');

    allMenus.forEach(m => {
      if (m.id !== id) m.classList.add('hidden');
    });

    const isHidden = menu.classList.contains('hidden');
    if (isHidden) {
      // Reset styles to default before measuring
      menu.style.top = '100%';
      menu.style.bottom = 'auto';
      menu.style.marginTop = '8px';
      menu.style.marginBottom = '0';

      menu.classList.remove('hidden');

      const rect = menu.getBoundingClientRect();
      const viewportHeight = window.innerHeight;

      // Only open upwards if it actually hits or exceeds the viewport bottom
      if (rect.bottom > viewportHeight - 10) {
        menu.style.top = 'auto';
        menu.style.bottom = '100%';
        menu.style.marginTop = '0';
        menu.style.marginBottom = '8px';
      }
    } else {
      menu.classList.add('hidden');
    }
  }

  window.addEventListener('click', function (e) {
    const allMenus = document.querySelectorAll('[id^="menu-"]');
    allMenus.forEach(m => {
      if (!m.contains(e.target)) {
        m.classList.add('hidden');
      }
    });
  });
</script>
{% endblock %}