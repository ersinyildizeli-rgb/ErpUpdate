{% extends 'base.html' %}

{% block content %}
<div class="max-w-6xl mx-auto pb-20" x-data="faturaForm()">
    <form action="/fatura/ekle" method="POST" class="flex flex-col gap-8">
        <div class="flex items-center justify-between">
            <h1 class="text-3xl font-bold text-slate-900 tracking-tight">Yeni Fatura Oluştur</h1>
            <div class="flex gap-3">
                <a href="/faturalar"
                    class="px-6 py-3 rounded-xl border border-slate-200 font-bold text-slate-600 hover:bg-slate-50 transition-all">İptal</a>
                <button type="submit"
                    class="px-8 py-3 rounded-xl bg-primary text-white font-bold shadow-lg shadow-primary/25 hover:bg-blue-700 transition-all active:scale-95">Faturayı
                    Kaydet</button>
            </div>
        </div>

        <!-- Upper Info -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 bg-white p-8 rounded-3xl border border-slate-200 shadow-sm">
            <div class="flex flex-col gap-2">
                <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Fatura Türü</label>
                <select name="fatura_turu"
                    class="w-full h-12 px-4 rounded-xl border-slate-200 font-bold focus:ring-primary focus:border-primary transition-all">
                    <option value="Satış">Satış Faturası</option>
                    <option value="Alış">Alış Faturası</option>
                </select>
            </div>
            <div class="flex flex-col gap-2">
                <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Fatura No</label>
                <input type="text" name="fatura_no" value="{{ current_no }}" required
                    class="w-full h-12 px-4 rounded-xl border-slate-200 font-bold focus:ring-primary focus:border-primary">
            </div>
            <div class="flex flex-col gap-2">
                <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Tarih</label>
                <input type="date" name="tarih" value="{{ now_date_str }}" required
                    class="w-full h-12 px-4 rounded-xl border-slate-200 font-bold focus:ring-primary focus:border-primary">
            </div>
            <div class="flex flex-col gap-2">
                <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Cari Hesap</label>
                <select name="cari_id" required
                    class="w-full h-12 px-4 rounded-xl border-slate-200 font-bold focus:ring-primary focus:border-primary">
                    <option value="">Seçiniz...</option>
                    {% for c in cariler %}
                    <option value="{{ c.CariID }}">{{ c.Unvan }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <!-- Barcode Scanner Input -->
        <div
            class="bg-slate-900 p-4 rounded-3xl shadow-lg shadow-slate-900/10 flex items-center gap-4 border border-white/5">
            <div
                class="size-11 rounded-full bg-primary/20 flex items-center justify-center text-primary group-hover:scale-110 transition-transform">
                <span class="material-symbols-outlined text-[24px]">barcode_scanner</span>
            </div>
            <div class="flex-1">
                <input type="text" placeholder="Barkod OKUTUN veya YAZIN ve ENTER'a basın..." x-model="barcodeInput"
                    @keydown.enter.prevent="handleBarcode()"
                    class="w-full bg-transparent border-none focus:ring-0 text-white font-black placeholder:text-slate-500 text-base">
            </div>
            <div class="hidden md:flex flex-col items-end gap-0.5">
                <span class="text-[9px] font-black text-emerald-400 uppercase tracking-widest">Hızlı giriş aktif</span>
                <span class="text-[8px] font-bold text-slate-500 uppercase">Tarayıcı hazır</span>
            </div>
        </div>

        <!-- Line Items -->
        <div class="bg-white rounded-3xl border border-slate-200 shadow-sm overflow-hidden text-sm">
            <div class="bg-slate-50 border-b border-slate-200 px-8 py-4 flex items-center justify-between">
                <h3 class="font-bold text-slate-700 uppercase tracking-tighter">Fatura Kalemleri</h3>
                <button type="button" @click="addRow()"
                    class="flex items-center gap-2 text-primary hover:text-blue-700 font-bold bg-white px-4 py-2 rounded-lg border border-slate-200 shadow-sm transition-all active:scale-95">
                    <span class="material-symbols-outlined text-[18px]">add</span>
                    Satır Ekle
                </button>
            </div>

            <table class="w-full">
                <thead>
                    <tr class="bg-slate-50 text-slate-500 font-bold text-[10px] uppercase border-b border-slate-100">
                        <th class="px-8 py-4 text-left">Ürün / Hizmet</th>
                        <th class="px-4 py-4 text-left w-48">Seri No (Opsiyonel)</th>
                        <th class="px-4 py-4 text-right w-32">Miktar</th>
                        <th class="px-4 py-4 text-right w-40">Birim Fiyat (₺)</th>
                        <th class="px-4 py-4 text-center w-24">KDV (%)</th>
                        <th class="px-4 py-4 text-right w-40">Satır Toplamı (Net)</th>
                        <th class="px-8 py-4 text-center w-20"></th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-slate-100">
                    <template x-for="(row, index) in rows" :key="index">
                        <tr class="hover:bg-slate-50/50 transition-colors">
                            <td class="px-8 py-4">
                                <select :name="'urun_id[]'" required x-model="row.urun_id" @change="updatePrice(index)"
                                    class="w-full h-11 px-3 rounded-lg border-slate-200 text-xs font-bold focus:ring-primary focus:border-primary">
                                    <option value="">Ürün Seçin...</option>
                                    {% for u in urunler %}
                                    <option value="{{ u.UrunID }}" data-price="{{ u.SatisFiyati or 0 }}"
                                        data-kdv="{{ u.KDV or 20 }}">{{ u.UrunAdi }}</option>
                                    {% endfor %}
                                </select>
                            </td>
                            <td class="px-4 py-4">
                                <input type="text" :name="'seri_no[]'" x-model="row.seri_no" placeholder="S/N..."
                                    class="w-full h-11 px-3 rounded-lg border-slate-200 text-xs font-bold focus:ring-primary focus:border-primary">
                            </td>
                            <td class="px-4 py-4">
                                <input type="number" step="0.01" :name="'miktar[]'" x-model="row.miktar" required
                                    @input="calculateTotals()"
                                    class="w-full h-11 px-3 text-right rounded-lg border-slate-200 font-bold focus:ring-primary focus:border-primary">
                            </td>
                            <td class="px-4 py-4">
                                <input type="number" step="0.01" :name="'birim_fiyat[]'" x-model="row.birim_fiyat"
                                    required @input="calculateTotals()"
                                    class="w-full h-11 px-3 text-right rounded-lg border-slate-200 font-bold focus:ring-primary focus:border-primary">
                            </td>
                            <td class="px-4 py-4">
                                <select :name="'kdv[]'" x-model="row.kdv" @change="calculateTotals()"
                                    class="w-full h-11 px-3 rounded-lg border-slate-200 font-bold text-center focus:ring-primary focus:border-primary">
                                    <option value="0">0</option>
                                    <option value="1">1</option>
                                    <option value="10">10</option>
                                    <option value="20">20</option>
                                </select>
                            </td>
                            <td class="px-4 py-4 text-right font-black text-slate-900 tabular-nums">
                                <span x-text="formatCurrency(row.miktar * row.birim_fiyat)"></span> ₺
                            </td>
                            <td class="px-8 py-4 text-center">
                                <button type="button" @click="removeRow(index)"
                                    class="text-rose-500 hover:text-rose-700 transition-colors p-1"
                                    x-show="rows.length > 1">
                                    <span class="material-symbols-outlined text-[20px]">delete</span>
                                </button>
                            </td>
                        </tr>
                    </template>
                </tbody>
            </table>
        </div>

        <!-- Summary and Bottom -->
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            <div class="lg:col-span-8">
                <div class="bg-white p-8 rounded-3xl border border-slate-200 shadow-sm h-full">
                    <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-3 block">Fatura
                        Açıklaması</label>
                    <textarea name="aciklama" rows="5" placeholder="Müşteriye özel not veya ödeme koşulları..."
                        class="w-full p-4 rounded-xl border-slate-200 font-medium focus:ring-primary focus:border-primary"></textarea>
                </div>
            </div>
            <div class="lg:col-span-4">
                <div class="bg-slate-900 text-white p-8 rounded-3xl shadow-xl shadow-slate-900/20 flex flex-col gap-6">
                    <div
                        class="flex justify-between items-center text-slate-400 font-bold text-xs uppercase tracking-widest">
                        <span>Ara Toplam</span>
                        <span class="text-white tabular-nums" x-text="'₺' + formatCurrency(totals.subtotal)"></span>
                    </div>
                    <div
                        class="flex justify-between items-center text-slate-400 font-bold text-xs uppercase tracking-widest">
                        <span>KDV Toplam</span>
                        <span class="text-white tabular-nums" x-text="'₺' + formatCurrency(totals.tax)"></span>
                    </div>
                    <div class="h-px bg-white/10"></div>
                    <div class="flex justify-between items-center">
                        <span class="font-black text-sm uppercase">Genel Toplam</span>
                        <span class="text-2xl font-black tabular-nums text-emerald-400"
                            x-text="'₺' + formatCurrency(totals.grand)"></span>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<script>
    function faturaForm() {
        return {
            rows: [
                { urun_id: '', miktar: 1, birim_fiyat: 0, kdv: 20, seri_no: '' }
            ],
            totals: {
                subtotal: 0,
                tax: 0,
                grand: 0
            },
            barcodeInput: '',
            handleBarcode() {
                if (!this.barcodeInput) return;

                const products = [
                    {% for u in urunler %}
                    { "id": "{{ u.UrunID }}", "barcode": "{{ u.Barkod }}", "price": { { u.SatisFiyati or 0 } }, "kdv": { { u.KDV or 20 } } } {% if not loop.last %}, {% endif %}
        {% endfor %}
                ];

        const found = products.find(p => p.barcode === this.barcodeInput);
        if (found) {
            const existingRow = this.rows.find(r => r.urun_id == found.id);
            if (existingRow) {
                existingRow.miktar = parseFloat(existingRow.miktar) + 1;
            } else {
                if (this.rows.length === 1 && !this.rows[0].urun_id) {
                    this.rows[0].urun_id = found.id;
                    this.rows[0].birim_fiyat = found.price;
                    this.rows[0].kdv = found.kdv;
                } else {
                    this.rows.push({ urun_id: found.id, miktar: 1, birim_fiyat: found.price, kdv: found.kdv, seri_no: '' });
                }
            }
            this.calculateTotals();
        } else {
            alert('Barkod bulunamadı: ' + this.barcodeInput);
        }
        this.barcodeInput = '';
    },
    addRow() {
        this.rows.push({ urun_id: '', miktar: 1, birim_fiyat: 0, kdv: 20, seri_no: '' });
    },
    removeRow(index) {
        this.rows.splice(index, 1);
        this.calculateTotals();
    },
    updatePrice(index) {
        const select = document.querySelectorAll('select[name="urun_id[]"]')[index];
        const option = select.selectedOptions[0];
        if (option && option.value) {
            this.rows[index].birim_fiyat = parseFloat(option.dataset.price);
            this.rows[index].kdv = parseInt(option.dataset.kdv);
        }
        this.calculateTotals();
    },
    calculateTotals() {
        let sub = 0;
        let tax = 0;
        this.rows.forEach(row => {
            const rowSub = (parseFloat(row.miktar) || 0) * (parseFloat(row.birim_fiyat) || 0);
            const rowTax = rowSub * (parseInt(row.kdv) / 100);
            sub += rowSub;
            tax += rowTax;
        });
        this.totals.subtotal = sub;
        this.totals.tax = tax;
        this.totals.grand = sub + tax;
    },
    formatCurrency(val) {
        return new Intl.NumberFormat('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(val || 0);
    }
        }
    }
</script>
{% endblock %}