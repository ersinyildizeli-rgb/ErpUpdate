{% extends 'base.html' %}

{% block content %}
<div class="flex flex-col md:flex-row md:items-end justify-between gap-4">
  <div>
    <h2 class="text-2xl font-bold text-slate-900 tracking-tight">Personel Yönetimi</h2>
    <p class="text-slate-500 text-sm mt-1">Tüm çalışanların listesi, durumları ve finansal bilgileri.</p>
  </div>
  <div class="flex items-center gap-3">
    <div class="hidden md:flex relative group">
      <span
        class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 group-focus-within:text-primary transition-colors">search</span>
      <input id="desktopSearch" type="text"
        class="w-64 pl-10 pr-4 py-2.5 bg-white border border-slate-200 rounded-xl text-sm focus:border-primary focus:ring-0 shadow-sm transition-all"
        placeholder="Personel ara...">
    </div>
    <button id="filterBtn"
      class="hidden md:flex items-center gap-2 px-4 py-2.5 bg-white border border-slate-200 rounded-xl text-slate-700 text-sm font-medium hover:bg-slate-50 transition-colors shadow-sm"
      type="button">
      <span class="material-symbols-outlined text-[20px]">filter_list</span>
      Filtrele
    </button>
    <button id="exportBtn"
      class="hidden md:flex items-center gap-2 px-4 py-2.5 bg-white border border-slate-200 rounded-xl text-slate-700 text-sm font-medium hover:bg-slate-50 transition-colors shadow-sm"
      type="button">
      <span class="material-symbols-outlined text-[20px]">download</span>
      Dışa Aktar
    </button>
    <a href="/personel/create"
      class="flex items-center gap-2 px-5 py-2.5 bg-primary hover:bg-primary-dark text-white rounded-xl text-sm font-bold shadow-lg shadow-primary/30 transition-all hover:-translate-y-px active:translate-y-0">
      <span class="material-symbols-outlined text-[20px]">add</span>
      Personel Ekle
    </a>
  </div>
</div>

<div class="flex gap-4 overflow-x-auto pb-2 md:hidden mt-4">
  <div class="flex-1 min-w-[200px] relative">
    <span class="material-symbols-outlined absolute left-3 top-2.5 text-slate-400 text-[20px]">search</span>
    <input id="mobileSearch" type="text"
      class="w-full pl-10 pr-4 py-2 bg-white border border-slate-200 rounded-xl text-sm focus:border-primary focus:ring-0 shadow-sm"
      placeholder="Personel ara..." />
  </div>
  <select
    class="bg-white border border-slate-200 rounded-xl text-sm px-4 py-2 shadow-sm focus:border-primary focus:ring-0">
    <option>Tüm Departmanlar</option>
    <option>Yazılım</option>
    <option>İK</option>
    <option>Finans</option>
    <option>Satış</option>
  </select>
</div>

<div class="grid grid-cols-1 md:grid-cols-4 gap-4 mt-6">
  <div class="bg-white p-5 rounded-2xl border border-slate-200 shadow-sm flex items-center justify-between">
    <div>
      <p class="text-slate-500 text-xs font-medium uppercase tracking-wider">Toplam Personel</p>
      <h3 class="text-2xl font-bold text-slate-900 mt-1">{{ people|length }}</h3>
    </div>
    <div class="size-12 rounded-full bg-blue-50 text-blue-600 flex items-center justify-center">
      <span class="material-symbols-outlined">group</span>
    </div>
  </div>
  <div class="bg-white p-5 rounded-2xl border border-slate-200 shadow-sm flex items-center justify-between">
    <div>
      <p class="text-slate-500 text-xs font-medium uppercase tracking-wider">Aktif Çalışan</p>
      <h3 class="text-2xl font-bold text-slate-900 mt-1">{{ people|length }}</h3>
    </div>
    <div class="size-12 rounded-full bg-green-50 text-green-600 flex items-center justify-center">
      <span class="material-symbols-outlined">check_circle</span>
    </div>
  </div>
  <div class="bg-white p-5 rounded-2xl border border-slate-200 shadow-sm flex items-center justify-between">
    <div>
      <p class="text-slate-500 text-xs font-medium uppercase tracking-wider">İzindeki Personel</p>
      <h3 class="text-2xl font-bold text-slate-900 mt-1">0</h3>
    </div>
    <div class="size-12 rounded-full bg-orange-50 text-orange-600 flex items-center justify-center">
      <span class="material-symbols-outlined">beach_access</span>
    </div>
  </div>
  <div class="bg-white p-5 rounded-2xl border border-slate-200 shadow-sm flex items-center justify-between">
    <div>
      <p class="text-slate-500 text-xs font-medium uppercase tracking-wider">Yeni Başlayanlar</p>
      <h3 class="text-2xl font-bold text-slate-900 mt-1">+0</h3>
    </div>
    <div class="size-12 rounded-full bg-purple-50 text-purple-600 flex items-center justify-center">
      <span class="material-symbols-outlined">trending_up</span>
    </div>
  </div>
</div>

<div class="bg-white border border-slate-200 rounded-2xl shadow-sm overflow-hidden mt-6 flex flex-col">
  <div class="overflow-x-auto custom-scrollbar">
    <table class="w-full text-left border-collapse">
      <thead>
        <tr class="bg-slate-50 border-b border-slate-200">
          <th class="px-6 py-4 text-xs font-semibold text-slate-500 uppercase tracking-wider whitespace-nowrap">
            Ad Soyad</th>
          <th class="px-4 py-4 text-xs font-semibold text-slate-500 uppercase tracking-wider whitespace-nowrap">
            Departman</th>
          <th class="px-4 py-4 text-xs font-semibold text-slate-500 uppercase tracking-wider whitespace-nowrap">Ünvan
          </th>
          <th
            class="px-3 py-4 text-xs font-semibold text-slate-500 uppercase tracking-wider whitespace-nowrap text-right">
            Net Maaş</th>
          <th
            class="px-3 py-4 text-xs font-semibold text-slate-500 uppercase tracking-wider whitespace-nowrap text-right">
            Saatlik Ücret</th>
          <th class="px-3 py-4 text-xs font-semibold text-slate-500 uppercase tracking-wider whitespace-nowrap">Telefon
          </th>
          <th
            class="px-3 py-4 text-xs font-semibold text-slate-500 uppercase tracking-wider whitespace-nowrap text-center">
            Durum</th>
          <th
            class="px-4 py-4 text-xs font-semibold text-slate-500 uppercase tracking-wider whitespace-nowrap text-right">
            İşlemler</th>
        </tr>
      </thead>
      <tbody class="divide-y divide-slate-100">
        {% for p in people %}
        <tr class="hover:bg-slate-50/80 transition-colors group">
          <td class="px-4 py-4 whitespace-nowrap">
            <div class="flex items-center gap-3">
              <div
                class="size-9 rounded-full bg-primary/10 flex items-center justify-center text-primary font-bold text-sm ring-2 ring-white shadow-sm shrink-0">
                {{ p.Ad[0] if p.Ad else '?' }}{{ p.Soyad[0] if p.Soyad else '' }}
              </div>
              <div class="min-w-0">
                <div class="font-semibold text-slate-900 truncate">{{ p.Ad }} {{ p.Soyad }}</div>
                <div class="text-[10px] text-slate-500 truncate">{{ p.email if p.email else '' }}</div>
              </div>
            </div>
          </td>
          <td class="px-4 py-4 whitespace-nowrap text-sm text-slate-600">
            <div class="inline-flex items-center px-2 py-0.5 rounded-md text-xs font-medium border" {% if
              p.Departman=='Yazılım' %}
              class="inline-flex items-center px-2.5 py-0.5 rounded-md bg-blue-50 text-blue-700 text-xs font-medium border border-blue-100"
              {% elif p.Departman=='İnsan Kaynakları' %}
              class="inline-flex items-center px-2.5 py-0.5 rounded-md bg-purple-50 text-purple-700 text-xs font-medium border border-purple-100"
              {% elif p.Departman=='Satış' %}
              class="inline-flex items-center px-2.5 py-0.5 rounded-md bg-orange-50 text-orange-700 text-xs font-medium border border-orange-100"
              {% elif p.Departman=='Finans' %}
              class="inline-flex items-center px-2.5 py-0.5 rounded-md bg-teal-50 text-teal-700 text-xs font-medium border border-teal-100"
              {% else %}
              class="inline-flex items-center px-2.5 py-0.5 rounded-md bg-slate-50 text-slate-700 text-xs font-medium border border-slate-200"
              {% endif %}>
              {{ p.Departman or 'Genel' }}
            </div>
          </td>
          <td class="px-4 py-4 whitespace-nowrap text-sm text-slate-600 font-medium">{{ p.Unvan if p.Unvan else '' }}
          </td>
          <td class="px-3 py-4 whitespace-nowrap text-sm text-slate-700 text-right font-mono">{{ p.NetMaas|currency }}
            TL</td>
          <td class="px-3 py-4 whitespace-nowrap text-sm text-slate-700 text-right font-mono text-primary font-bold">{{
            p.hourly_rate|currency }} TL</td>
          <td class="px-3 py-4 whitespace-nowrap text-sm text-slate-500">{{ p.Telefon if p.Telefon else '' }}</td>
          <td class="px-3 py-4 whitespace-nowrap text-center">
            {% if p.Aktif %}
            <span
              class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-[11px] font-medium bg-green-50 text-green-700 border border-green-100">
              <span class="size-1 rounded-full bg-green-500"></span>
              Aktif
            </span>
            {% else %}
            <span
              class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-[11px] font-medium bg-slate-100 text-slate-600 border border-slate-200">
              <span class="size-1 rounded-full bg-slate-400"></span>
              Pasif
            </span>
            {% endif %}
          </td>
          <td class="px-4 py-4 whitespace-nowrap text-right">
            <div class="flex items-center justify-end gap-0.5">
              <button onclick="openDocViewer('Personel', {{ p.PersonelID }})"
                class="size-7 inline-flex items-center justify-center rounded-lg text-slate-400 hover:bg-slate-100 hover:text-primary transition-all"
                title="Belgeler">
                <span class="material-symbols-outlined text-[18px]">folder_open</span>
              </button>
              <a href="/personel/{{ p.PersonelID }}/edit"
                class="size-7 inline-flex items-center justify-center rounded-lg text-slate-400 hover:bg-blue-50 hover:text-blue-600 transition-all"
                title="Düzenle">
                <span class="material-symbols-outlined text-[18px]">edit</span>
              </a>
              <form action="/personel/{{ p.PersonelID }}/delete" method="post"
                onsubmit="return confirm('Bu personeli silmek istediğinize emin misiniz?')" class="inline-block">
                <button type="submit"
                  class="size-7 inline-flex items-center justify-center rounded-lg text-slate-300 hover:bg-red-50 hover:text-red-600 transition-all"
                  title="Sil">
                  <span class="material-symbols-outlined text-[18px]">delete</span>
                </button>
              </form>
            </div>
          </td>
        </tr>
        {% else %}
        <tr class="empty-row">
          <td colspan="8" class="px-6 py-4 text-center text-slate-500">Hiç personel yok.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <div class="px-6 py-4 border-t border-slate-200 bg-white flex items-center justify-between">
    <p class="text-sm text-slate-500">
      Toplam <span class="font-medium text-slate-900">{{ people|length }}</span> kayıt gösteriliyor
    </p>
    <div class="flex gap-2">
      <button class="px-3 py-1.5 text-sm font-medium text-slate-500 hover:bg-slate-100 rounded-lg disabled:opacity-50"
        disabled>Önceki</button>
      <button
        class="px-3 py-1.5 text-sm font-medium text-white bg-primary rounded-lg shadow-sm shadow-primary/30">1</button>
      <button class="px-3 py-1.5 text-sm font-medium text-slate-600 hover:bg-slate-100 rounded-lg">Sonraki</button>
    </div>
  </div>
</div>
<script>
  function toggleMenu(id) {
    if (window.event) event.stopPropagation();
    const menu = document.getElementById(id);
    if (!menu) return;
    const allMenus = document.querySelectorAll('[id^="menu-"]');

    allMenus.forEach(m => {
      if (m.id !== id) m.classList.add('hidden');
    });

    const isHidden = menu.classList.contains('hidden');
    if (isHidden) {
      // Reset styles to default before measuring
      menu.style.top = '100%';
      menu.style.bottom = 'auto';
      menu.style.marginTop = '8px';
      menu.style.marginBottom = '0';

      menu.classList.remove('hidden');

      const rect = menu.getBoundingClientRect();
      const viewportHeight = window.innerHeight;

      // Only open upwards if it actually hits or exceeds the viewport bottom
      if (rect.bottom > viewportHeight - 10) {
        menu.style.top = 'auto';
        menu.style.bottom = '100%';
        menu.style.marginTop = '0';
        menu.style.marginBottom = '8px';
      }
    } else {
      menu.classList.add('hidden');
    }
  }

  window.addEventListener('click', function (e) {
    const allMenus = document.querySelectorAll('[id^="menu-"]');
    allMenus.forEach(m => {
      if (!m.contains(e.target)) {
        m.classList.add('hidden');
      }
    });
  });

  // Filtreleme fonksiyonu
  function filterTable() {
    const desktopSearch = document.getElementById('desktopSearch').value.toLowerCase();
    const mobileSearch = document.getElementById('mobileSearch').value.toLowerCase();
    const searchValue = desktopSearch || mobileSearch;
    const tableBody = document.querySelector('tbody');
    const rows = tableBody.querySelectorAll('tr:not(.empty-row)');

    rows.forEach(row => {
      const text = row.textContent.toLowerCase();
      row.style.display = text.includes(searchValue) ? '' : 'none';
    });
  }

  document.getElementById('desktopSearch').addEventListener('input', filterTable);
  document.getElementById('mobileSearch').addEventListener('input', filterTable);

  // Filtrele butonu arama kutusuna odaklansın
  document.getElementById('filterBtn').addEventListener('click', function () {
    document.getElementById('desktopSearch').focus();
  });

  // Dışa Aktar fonksiyonu
  document.getElementById('exportBtn').addEventListener('click', function () {
    const table = document.querySelector('table');
    const rows = Array.from(table.querySelectorAll('thead tr, tbody tr:not(.empty-row)'));

    const csvContent = rows.map(row => {
      const cells = Array.from(row.querySelectorAll('th, td'));
      // İşlemler sütununu hariç tut (son sütun)
      const rowData = cells.slice(0, -1).map(cell => {
        let text = cell.innerText.replace(/[\n\r]+/g, ' ').trim();
        // Tırnak işaretlerini kaçır
        text = text.replace(/"/g, '""');
        return `"${text}"`;
      });
      return rowData.join(',');
    }).join('\n');

    const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.setAttribute('href', url);
    link.setAttribute('download', 'personel_listesi.csv');
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  });
</script>
{% endblock %}