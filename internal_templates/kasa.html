{% extends 'base.html' %}

{% block content %}
<div class="flex flex-col gap-6">
    <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
        <div>
            <h1 class="text-2xl font-bold text-slate-900 dark:text-white tracking-tight">Kasa Yönetimi</h1>
            <p class="text-slate-500 dark:text-slate-400 mt-1">Nakit akışını ve kasa hareketlerini anlık takip edin.</p>
        </div>
        <div class="flex gap-3">
            <button onclick="openModal('Gelir')"
                class="flex items-center gap-2 px-4 py-2.5 bg-green-600 hover:bg-green-700 text-white rounded-lg shadow-lg shadow-green-600/20 transition-all active:scale-95">
                <span class="material-symbols-outlined text-[20px]">add_circle</span>
                <span class="text-sm font-semibold">Kasa Girişi Ekle</span>
            </button>
            <button onclick="openModal('Gider')"
                class="flex items-center gap-2 px-4 py-2.5 bg-rose-600 hover:bg-rose-700 text-white rounded-lg shadow-lg shadow-rose-600/20 transition-all active:scale-95">
                <span class="material-symbols-outlined text-[20px]">remove_circle</span>
                <span class="text-sm font-semibold">Kasa Çıkışı Ekle</span>
            </button>
        </div>
    </div>

    <!-- Kasa Giriş/Çıkış Modalı -->
    <div id="kasaModal"
        class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[100] hidden flex items-center justify-center p-4">
        <div
            class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl w-full max-w-2xl overflow-hidden border border-slate-200 dark:border-slate-700 transform scale-100 transition-all flex flex-col max-h-[90vh]">
            <div
                class="flex items-center justify-between px-6 py-5 border-b border-slate-200 dark:border-slate-700 bg-slate-50/50 dark:bg-slate-900/50 shrink-0">
                <div class="flex items-center gap-3">
                    <div id="modalIconBg" class="size-10 rounded-full flex items-center justify-center">
                        <span id="modalIcon" class="material-symbols-outlined text-2xl"></span>
                    </div>
                    <div>
                        <h3 id="modalTitle" class="text-lg font-bold text-slate-900 dark:text-white leading-tight"></h3>
                        <p class="text-sm text-slate-500 dark:text-slate-400">Yeni bir nakit işlem kaydedin</p>
                    </div>
                </div>
                <button type="button" onclick="closeModal()"
                    class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-200 transition-colors">
                    <span class="material-symbols-outlined text-2xl">close</span>
                </button>
            </div>
            <form id="kasaForm" method="POST" action="/finans/add?type=kasa" enctype="multipart/form-data"
                class="flex flex-col">
                <input type="hidden" name="type" id="modalTypeInput">
                <input type="hidden" name="description" id="kasaDescriptionCombined">
                <div class="p-6 space-y-6 overflow-y-auto bg-white dark:bg-slate-800 max-h-[70vh]">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                        <div class="space-y-1.5">
                            <label for="kasaAmount"
                                class="block text-sm font-medium text-slate-700 dark:text-slate-300">
                                Tutar (₺) <span class="text-red-500">*</span>
                            </label>
                            <div class="relative">
                                <span
                                    class="absolute inset-y-0 left-0 pl-3 flex items-center text-slate-500 pointer-events-none">₺</span>
                                <input id="kasaAmount" name="amount" type="number" step="0.01" required
                                    class="block w-full pl-8 pr-4 py-2.5 rounded-lg border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-900 text-slate-900 dark:text-white placeholder-slate-400 focus:ring-2 focus:ring-indigo-600 focus:border-indigo-600 sm:text-sm font-medium transition-shadow shadow-sm"
                                    placeholder="0.00">
                            </div>
                        </div>
                        <div class="space-y-1.5">
                            <label for="kasaDate" class="block text-sm font-medium text-slate-700 dark:text-slate-300">
                                İşlem Tarihi <span class="text-red-500">*</span>
                            </label>
                            <div class="relative">
                                <span
                                    class="absolute inset-y-0 left-0 pl-3 flex items-center text-slate-500 pointer-events-none">
                                    <span class="material-symbols-outlined text-[20px]">calendar_today</span>
                                </span>
                                <input id="kasaDate" name="date" type="date" required value="{{ today_date }}"
                                    class="block w-full pl-10 pr-4 py-2.5 rounded-lg border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-900 text-slate-900 dark:text-white focus:ring-2 focus:ring-indigo-600 focus:border-indigo-600 sm:text-sm shadow-sm">
                            </div>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                        <div class="space-y-1.5">
                            <label id="kasaCariLabel" for="kasaCari"
                                class="block text-sm font-medium text-slate-700 dark:text-slate-300">
                                Cari Hesap <span class="text-slate-400 font-normal">(Opsiyonel)</span>
                            </label>
                            <div class="relative">
                                <span
                                    class="absolute inset-y-0 left-0 pl-3 flex items-center text-slate-500 pointer-events-none">
                                    <span class="material-symbols-outlined text-[20px]">groups</span>
                                </span>
                                <select id="kasaCari" name="cari_id"
                                    class="block w-full pl-10 pr-10 py-2.5 rounded-lg border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-900 text-slate-900 dark:text-white focus:ring-2 focus:ring-indigo-600 focus:border-indigo-600 sm:text-sm shadow-sm appearance-none">
                                    <option value="">Cari Seçilmedi</option>
                                    {% for c in cariler %}
                                    <option value="{{ c.CariID }}">{{ c.Unvan }} ({{ c.CariTipi }})</option>
                                    {% endfor %}
                                </select>
                                <div class="absolute inset-y-0 right-0 flex items-center px-2 pointer-events-none">
                                    <span class="material-symbols-outlined text-slate-500">expand_more</span>
                                </div>
                            </div>
                        </div>
                        <div class="space-y-1.5">
                            <label id="kasaCategoryLabel" for="kasaCategory"
                                class="block text-sm font-medium text-slate-700 dark:text-slate-300">
                                Kategori <span class="text-red-500">*</span>
                            </label>
                            <div class="relative">
                                <span
                                    class="absolute inset-y-0 left-0 pl-3 flex items-center text-slate-500 pointer-events-none">
                                    <span class="material-symbols-outlined text-[20px]">category</span>
                                </span>
                                <select id="kasaCategory" name="category" required
                                    class="block w-full pl-10 pr-10 py-2.5 rounded-lg border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-900 text-slate-900 dark:text-white focus:ring-2 focus:ring-indigo-600 focus:border-indigo-600 sm:text-sm shadow-sm appearance-none">
                                    <option value="" disabled selected>Kategori Seçiniz</option>
                                    <option value="Nakit Satış" data-type="Gelir">Nakit Satış</option>
                                    <option value="Tahsilat" data-type="Gelir">Tahsilat</option>
                                    <option value="Avans İadesi" data-type="Gelir">Avans İadesi</option>
                                    <option value="Bankadan Çekilen" data-type="Gelir">Bankadan Çekilen</option>
                                    <option value="Diğer Gelirler" data-type="Gelir">Diğer Gelirler</option>
                                    <option value="Maaş Ödemesi" data-type="Gider">Maaş Ödemesi</option>
                                    <option value="Kira" data-type="Gider">Kira</option>
                                    <option value="Faturalar" data-type="Gider">Faturalar</option>
                                    <option value="Vergi / SGK" data-type="Gider">Vergi / SGK</option>
                                    <option value="Yemek / Mutfak" data-type="Gider">Yemek / Mutfak</option>
                                    <option value="Diğer Giderler" data-type="Gider">Diğer Giderler</option>
                                </select>
                                <div class="absolute inset-y-0 right-0 flex items-center px-2 pointer-events-none">
                                    <span class="material-symbols-outlined text-slate-500">expand_more</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="space-y-1.5">
                        <label for="kasaReason" class="block text-sm font-medium text-slate-700 dark:text-slate-300">
                            Ne İçin <span class="text-slate-400 font-normal">(Opsiyonel - Detay)</span>
                        </label>
                        <input id="kasaReason" type="text"
                            class="block w-full px-4 py-2.5 rounded-lg border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-900 text-slate-900 dark:text-white placeholder-slate-400 focus:ring-2 focus:ring-indigo-600 focus:border-indigo-600 sm:text-sm shadow-sm"
                            placeholder="Örn: Ekim ayı fatura ödemesi, Personel yemek ücret iadesi...">
                    </div>
                    <div class="space-y-1.5">
                        <label for="kasaPersonnel" class="block text-sm font-medium text-slate-700 dark:text-slate-300">
                            İşlem Yapan <span class="text-red-500">*</span>
                        </label>
                        <div class="relative">
                            <span
                                class="absolute inset-y-0 left-0 pl-3 flex items-center text-slate-500 pointer-events-none">
                                <span class="material-symbols-outlined text-[20px]">person</span>
                            </span>
                            <select id="kasaPersonnel" required
                                class="block w-full pl-10 pr-10 py-2.5 rounded-lg border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-900 text-slate-900 dark:text-white focus:ring-2 focus:ring-indigo-600 focus:border-indigo-600 sm:text-sm shadow-sm appearance-none">
                                <option value="">Personel Seçiniz</option>
                                {% for p in personnel %}
                                <option value="{{ p.PersonelID }}">{{ p.Ad }} {{ p.Soyad }}</option>
                                {% endfor %}
                            </select>
                            <div class="absolute inset-y-0 right-0 flex items-center px-2 pointer-events-none">
                                <span class="material-symbols-outlined text-slate-500">expand_more</span>
                            </div>
                        </div>
                    </div>
                    <div class="space-y-1.5">
                        <label for="kasaNotes" class="block text-sm font-medium text-slate-700 dark:text-slate-300">
                            Açıklama <span class="text-slate-400 font-normal">(Notlar)</span>
                        </label>
                        <textarea id="kasaNotes"
                            class="block w-full px-4 py-2.5 rounded-lg border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-900 text-slate-900 dark:text-white placeholder-slate-400 focus:ring-2 focus:ring-indigo-600 focus:border-indigo-600 sm:text-sm shadow-sm min-h-[80px]"
                            placeholder="Eklemek istediğiniz notlar..."></textarea>
                    </div>
                    <!-- Belge Yükleme Section -->
                    <div class="space-y-3 pt-2 border-t border-slate-100 dark:border-slate-700">
                        <label
                            class="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-[0.1em]">
                            Belge / Makbuz Görseli (Opsiyonel)
                        </label>
                        <div
                            class="p-4 rounded-xl border-2 border-dashed border-slate-200 dark:border-slate-700 bg-slate-50/50 dark:bg-slate-900/40">
                            <input type="file" name="files[]" multiple accept="image/*"
                                onchange="handleKasaFiles(event)"
                                class="text-xs w-full file:mr-3 file:py-2 file:px-3 file:rounded-lg file:bg-primary/10 file:text-primary file:border-0 cursor-pointer font-bold transition-all hover:bg-primary/20" />
                            <div id="kasa-file-previews" class="flex flex-wrap gap-2 mt-2"></div>
                            <p class="text-[10px] text-slate-400 italic mt-2 flex items-center gap-1">
                                <span class="material-symbols-outlined text-[14px]">info</span>
                                Belge seçebilir veya doğrudan fotoğraf çekebilirsiniz.
                            </p>
                        </div>
                    </div>
                </div>
                <div
                    class="flex items-center justify-end gap-3 px-6 py-5 bg-slate-50 dark:bg-slate-900/50 border-t border-slate-200 dark:border-slate-700 shrink-0">
                    <button type="button" onclick="closeModal()"
                        class="px-4 py-2.5 text-sm font-semibold text-slate-700 dark:text-slate-300 bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-700 focus:ring-2 focus:ring-indigo-600/20 transition-all shadow-sm">
                        İptal
                    </button>
                    <button type="submit" id="modalSubmitBtn"
                        class="px-4 py-2.5 text-sm font-semibold text-white bg-indigo-600 rounded-lg hover:bg-indigo-700 focus:ring-4 focus:ring-indigo-600/20 shadow-lg shadow-indigo-600/20 transition-all flex items-center gap-2">
                        <span class="material-symbols-outlined text-[18px]">save</span>
                        Kaydet
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div
            class="lg:col-span-1 relative overflow-hidden rounded-2xl bg-gradient-to-br from-[#1a1a2e] to-[#2c2c4d] text-white p-6 shadow-xl">
            <div class="relative z-10 flex flex-col h-full justify-between">
                <div>
                    <div class="flex items-center gap-2 mb-2 text-slate-300">
                        <span class="material-symbols-outlined text-[20px]">account_balance_wallet</span>
                        <span class="text-sm font-medium">Toplam Kasa Bakiyesi</span>
                    </div>
                    <h2 class="text-4xl font-bold tracking-tight">₺{{ '{:,.2f}'.format(cash_balance or 0) }}</h2>
                </div>
                <div class="mt-8 pt-4 border-t border-white/10 flex items-center justify-between">
                    <div
                        class="flex items-center gap-1.5 text-emerald-400 bg-emerald-400/10 px-2 py-1 rounded text-sm font-medium">
                        <span class="material-symbols-outlined text-[16px]">trending_up</span>
                        <span>+12%</span>
                    </div>
                    <span class="text-xs text-slate-400">Geçen aya göre</span>
                </div>
            </div>
            <div class="absolute top-0 right-0 -mr-8 -mt-8 w-32 h-32 rounded-full bg-primary/20 blur-2xl"></div>
            <div class="absolute bottom-0 left-0 -ml-8 -mb-8 w-24 h-24 rounded-full bg-purple-500/20 blur-2xl"></div>
        </div>

        <div
            class="lg:col-span-2 bg-white dark:bg-slate-800 p-0 rounded-2xl border border-slate-200 dark:border-slate-700 shadow-sm flex flex-col sm:flex-row h-auto lg:h-full">
            <div
                class="flex-1 p-6 border-b sm:border-b-0 sm:border-r border-slate-100 dark:border-slate-700/50 flex flex-col justify-center">
                <div class="flex items-center gap-3 mb-2">
                    <div
                        class="size-8 rounded-lg bg-emerald-100 dark:bg-emerald-900/30 flex items-center justify-center text-emerald-600 dark:text-emerald-400">
                        <span class="material-symbols-outlined text-[18px]">arrow_downward</span>
                    </div>
                    <span class="text-sm font-medium text-slate-500 dark:text-slate-400">Bugünkü Girişler</span>
                </div>
                <p class="text-2xl font-bold text-slate-900 dark:text-white">₺{{ '{:,.2f}'.format(today_income or 0) }}
                </p>
                <p class="text-xs text-slate-400 mt-1">{{ today_income_count or 0 }} işlem kaydedildi</p>
            </div>
            <div
                class="flex-1 p-6 border-b sm:border-b-0 sm:border-r border-slate-100 dark:border-slate-700/50 flex flex-col justify-center">
                <div class="flex items-center gap-3 mb-2">
                    <div
                        class="size-8 rounded-lg bg-rose-100 dark:bg-rose-900/30 flex items-center justify-center text-rose-600 dark:text-rose-400">
                        <span class="material-symbols-outlined text-[18px]">arrow_upward</span>
                    </div>
                    <span class="text-sm font-medium text-slate-500 dark:text-slate-400">Bugünkü Çıkışlar</span>
                </div>
                <p class="text-2xl font-bold text-slate-900 dark:text-white">₺{{ '{:,.2f}'.format(today_expense or 0) }}
                </p>
                <p class="text-xs text-slate-400 mt-1">{{ today_expense_count or 0 }} işlem kaydedildi</p>
            </div>
            <div class="flex-1 p-6 flex flex-col justify-center bg-slate-50/50 dark:bg-slate-700/10 rounded-r-2xl">
                <div class="flex items-center gap-3 mb-2">
                    <div
                        class="size-8 rounded-lg bg-blue-100 dark:bg-blue-900/30 flex items-center justify-center text-primary dark:text-blue-400">
                        <span class="material-symbols-outlined text-[18px]">calendar_month</span>
                    </div>
                    <span class="text-sm font-medium text-slate-500 dark:text-slate-400">Bu Ay Net</span>
                </div>
                <p class="text-2xl font-bold text-primary dark:text-blue-400">{{ '+' if month_net > 0 else '' }}₺{{
                    '{:,.2f}'.format(month_net or 0) }}</p>
                <div class="w-full bg-slate-200 dark:bg-slate-600 rounded-full h-1.5 mt-2">
                    <div class="bg-primary h-1.5 rounded-full" style="width: 65%"></div>
                </div>
            </div>
        </div>
    </div>

    <div
        class="bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 shadow-sm flex flex-col">
        <div
            class="p-5 border-b border-slate-200 dark:border-slate-700 flex flex-col sm:flex-row gap-4 justify-between items-center">
            <div class="relative w-full sm:max-w-xs">
                <span
                    class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-[20px]">search</span>
                <input
                    class="w-full pl-10 pr-4 py-2 rounded-lg border border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-900 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-primary/50 text-sm transition-shadow"
                    placeholder="Açıklama veya işlem ara..." type="text" />
            </div>
            <div class="flex items-center gap-2">
                <div class="hidden md:flex relative group mr-2">
                    <span
                        class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 group-focus-within:text-primary transition-colors">search</span>
                    <input id="kasaSearch" type="text"
                        class="w-64 pl-10 pr-4 py-2 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl text-sm focus:border-primary focus:ring-0 shadow-sm transition-all text-slate-900 dark:text-white"
                        placeholder="İşlem ara...">
                </div>
                <div
                    class="flex p-1 bg-slate-50 dark:bg-slate-900 rounded-xl border border-slate-200 dark:border-slate-700">
                    <button
                        class="px-3 py-1.5 rounded-md text-sm font-medium text-slate-500 hover:text-slate-800 dark:hover:text-slate-200 hover:bg-white/50 dark:hover:bg-slate-800/50 transition-all">Girişler</button>
                    <button
                        class="px-3 py-1.5 rounded-md text-sm font-medium text-slate-500 hover:text-slate-800 dark:hover:text-slate-200 hover:bg-white/50 dark:hover:bg-slate-800/50 transition-all">Çıkışlar</button>
                </div>
                <button id="kasaFilterBtn"
                    class="p-2 rounded-lg border border-slate-200 dark:border-slate-700 text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors">
                    <span class="material-symbols-outlined text-[20px]">filter_alt</span>
                </button>
                <button id="kasaExportBtn"
                    class="p-2 rounded-lg border border-slate-200 dark:border-slate-700 text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors">
                    <span class="material-symbols-outlined text-[20px]">download</span>
                </button>
            </div>
        </div>
        <div class="overflow-x-auto">
            <table class="w-full text-left text-sm">
                <thead
                    class="bg-slate-50 dark:bg-slate-700/20 text-slate-500 dark:text-slate-400 font-medium border-b border-slate-200 dark:border-slate-700">
                    <tr>
                        <th class="px-6 py-4 w-32">İşlem Tipi</th>
                        <th class="px-6 py-4">Açıklama</th>
                        <th class="px-6 py-4 text-right">Tutar</th>
                        <th class="px-6 py-4">İşlem Tarihi</th>
                        <th class="px-6 py-4">Kategori</th>
                        <th class="px-6 py-4 text-right whitespace-nowrap">İşlemler</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-slate-200 dark:divide-slate-700">
                    {% for f in entries %}
                    <tr class="group hover:bg-slate-50 dark:hover:bg-slate-800/50 transition-colors">
                        <td class="px-6 py-4">
                            {% if f.IslemTuru.lower() == 'gelir' %}
                            <span
                                class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-semibold bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-400 border border-emerald-200 dark:border-emerald-800">
                                <span class="material-symbols-outlined text-[14px]">arrow_downward</span>
                                Giriş
                            </span>
                            {% else %}
                            <span
                                class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-semibold bg-rose-100 text-rose-700 dark:bg-rose-900/30 dark:text-rose-400 border border-rose-200 dark:border-rose-800">
                                <span class="material-symbols-outlined text-[14px]">arrow_upward</span>
                                Çıkış
                            </span>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4">
                            <div class="flex flex-col">
                                <p class="font-medium text-slate-900 dark:text-white">{{ f.Aciklama or '-' }}</p>
                                {% if f.Cari %}
                                <span class="text-[10px] text-primary font-bold flex items-center gap-0.5">
                                    <span class="material-symbols-outlined text-[12px]">groups</span>
                                    Cari: {{ f.Cari.Unvan }}
                                </span>
                                {% endif %}
                            </div>
                        </td>
                        <td class="px-6 py-4 text-right">
                            <span
                                class="font-bold {% if f.IslemTuru.lower() == 'gelir' %}text-emerald-600{% else %}text-rose-600{% endif %}">
                                {{ '+' if f.IslemTuru.lower() == 'gelir' else '-' }} ₺{{ '{:,.2f}'.format(f.Tutar or 0)
                                }}
                            </span>
                        </td>
                        <td class="px-6 py-4 text-slate-600 dark:text-slate-300">
                            {{ f.Tarih.strftime('%d.%m.%Y') if f.Tarih else '-' }}
                        </td>
                        <td class="px-6 py-4 text-slate-600 dark:text-slate-300">
                            {{ f.Kategori or '-' }}
                        </td>
                        <td class="px-6 py-4 text-right">
                            <div class="flex items-center justify-end gap-1">
                                <button onclick="openDocViewer('Finans', {{ f.FinansID }})"
                                    class="size-8 inline-flex items-center justify-center rounded-lg text-slate-400 hover:bg-slate-100 hover:text-primary transition-all"
                                    title="Belgeler">
                                    <span class="material-symbols-outlined text-[18px]">folder_open</span>
                                </button>
                                <a href="/finans/{{ f.FinansID }}/edit?next=/kasa"
                                    class="size-8 inline-flex items-center justify-center rounded-lg text-slate-400 hover:bg-blue-50 hover:text-blue-600 transition-all"
                                    title="Düzenle">
                                    <span class="material-symbols-outlined text-[18px]">edit</span>
                                </a>
                                <form action="/finans/{{ f.FinansID }}/delete?next=/kasa" method="post"
                                    onsubmit="return confirm('Bu işlemi silmek istediğinize emin misiniz?')"
                                    class="inline-block">
                                    <button type="submit"
                                        class="size-8 inline-flex items-center justify-center rounded-lg text-slate-300 hover:bg-red-50 hover:text-red-600 transition-all"
                                        title="Sil">
                                        <span class="material-symbols-outlined text-[18px]">delete</span>
                                    </button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    {% else %}
                    <tr class="empty-row">
                        <td colspan="6" class="px-6 py-4 text-center text-slate-500">Hiç işlem yok.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    function openModal(type) {
        const modal = document.getElementById('kasaModal');
        const title = document.getElementById('modalTitle');
        const icon = document.getElementById('modalIcon');
        const iconBg = document.getElementById('modalIconBg');
        const typeInput = document.getElementById('modalTypeInput');
        const submitBtn = document.getElementById('modalSubmitBtn');
        const categoryLabel = document.getElementById('kasaCategoryLabel');
        const categorySelect = document.getElementById('kasaCategory');

        typeInput.value = type;

        if (type === 'Gelir') {
            title.innerText = 'Kasa Girişi Ekle';
            icon.innerText = 'add_circle';
            iconBg.className = 'w-10 h-10 rounded-full bg-emerald-100 dark:bg-emerald-900/30 flex items-center justify-center text-emerald-600 dark:text-emerald-400';
            submitBtn.className = 'h-11 px-6 rounded-lg bg-emerald-600 hover:bg-emerald-700 text-white font-medium shadow-md shadow-emerald-500/20 hover:shadow-lg hover:shadow-emerald-500/30 focus:ring-4 focus:ring-emerald-500/30 transition-all text-sm flex items-center gap-2';
            if (categoryLabel) {
                categoryLabel.innerHTML = 'Kategori <span class="text-red-500">*</span>';
            }
            if (categorySelect) {
                Array.from(categorySelect.options).forEach(opt => {
                    if (!opt.value) {
                        opt.selected = true;
                        return;
                    }
                    if (opt.dataset.type === 'Gelir') {
                        opt.hidden = false;
                    } else if (opt.dataset.type === 'Gider') {
                        opt.hidden = true;
                    }
                });
            }
        } else {
            title.innerText = 'Kasa Çıkışı Ekle';
            icon.innerText = 'remove_circle';
            iconBg.className = 'w-10 h-10 rounded-full bg-rose-100 dark:bg-rose-900/30 flex items-center justify-center text-rose-600 dark:text-rose-400';
            submitBtn.className = 'h-11 px-6 rounded-lg bg-rose-600 hover:bg-rose-700 text-white font-medium shadow-md shadow-rose-500/20 hover:shadow-lg hover:shadow-rose-500/30 focus:ring-4 focus:ring-rose-500/30 transition-all text-sm flex items-center gap-2';
            if (categoryLabel) {
                categoryLabel.innerHTML = 'Kategori <span class="text-red-500">*</span>';
            }
            if (categorySelect) {
                Array.from(categorySelect.options).forEach(opt => {
                    if (!opt.value) {
                        opt.selected = true;
                        return;
                    }
                    if (opt.dataset.type === 'Gelir') {
                        opt.hidden = true;
                    } else if (opt.dataset.type === 'Gider') {
                        opt.hidden = false;
                    }
                });
            }
        }

        modal.classList.remove('hidden');
    }

    function handleKasaFiles(e) {
        const container = document.getElementById('kasa-file-previews');
        container.innerHTML = '';
        for (const file of e.target.files) {
            const badge = document.createElement('div');
            badge.className = 'text-[10px] font-bold bg-primary/10 text-primary px-2 py-1 rounded border border-primary/20 shrink-0';
            badge.innerText = file.name;
            container.appendChild(badge);
        }
    }

    function closeModal() {
        document.getElementById('kasaModal').classList.add('hidden');
        document.getElementById('kasaForm').reset();
    }

    function toggleMenu(id, event) {
        if (event) event.stopPropagation();
        else if (window.event) window.event.stopPropagation();
        const menu = document.getElementById(id);
        if (!menu) return;
        const allMenus = document.querySelectorAll('[id^="menu-"]');
        allMenus.forEach(m => {
            if (m.id !== id) m.classList.add('hidden');
        });

        const isHidden = menu.classList.contains('hidden');
        if (isHidden) {
            // Reset styles to default before measuring
            menu.style.top = '100%';
            menu.style.bottom = 'auto';
            menu.style.marginTop = '8px';
            menu.style.marginBottom = '0';

            menu.classList.remove('hidden');

            const rect = menu.getBoundingClientRect();
            const viewportHeight = window.innerHeight;

            // Only open upwards if it actually hits or exceeds the viewport bottom
            if (rect.bottom > viewportHeight - 10) {
                menu.style.top = 'auto';
                menu.style.bottom = '100%';
                menu.style.marginTop = '0';
                menu.style.marginBottom = '8px';
            }
        } else {
            menu.classList.add('hidden');
        }
    }

    document.addEventListener('click', function (event) {
        if (!event.target.closest('button') && !event.target.closest('[id^="menu-"]')) {
            const allMenus = document.querySelectorAll('[id^="menu-"]');
            allMenus.forEach(m => m.classList.add('hidden'));
        }
    });

    const kasaForm = document.getElementById('kasaForm');
    if (kasaForm) {
        kasaForm.addEventListener('submit', function () {
            const reason = document.getElementById('kasaReason');
            const personnel = document.getElementById('kasaPersonnel');
            const notes = document.getElementById('kasaNotes');
            const category = document.getElementById('kasaCategory');
            const descriptionInput = document.getElementById('kasaDescriptionCombined');
            const cari = document.getElementById('kasaCari');
            const parts = [];
            if (cari && cari.value) {
                const cariText = cari.options[cari.selectedIndex].text;
                parts.push('Cari: ' + cariText);
            }
            if (reason && reason.value) {
                parts.push('Ne İçin: ' + reason.value);
            }
            if (category && category.value) {
                const catText = category.options[category.selectedIndex].text;
                parts.push('Kategori: ' + catText);
            }
            if (personnel && personnel.value) {
                const text = personnel.options[personnel.selectedIndex].text;
                parts.push('İşlem Yapan: ' + text);
            }
            if (notes && notes.value) {
                parts.push('Not: ' + notes.value);
            }
            if (descriptionInput) {
                descriptionInput.value = parts.join(' | ');
            }
        });
    }

    const kasaSearch = document.getElementById('kasaSearch');
    if (kasaSearch) {
        kasaSearch.addEventListener('input', function () {
            const searchValue = this.value.toLowerCase();
            const rows = document.querySelectorAll('tbody tr:not(.empty-row)');
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchValue) ? '' : 'none';
            });
        });
    }

    const kasaFilterBtn = document.getElementById('kasaFilterBtn');
    if (kasaFilterBtn && kasaSearch) {
        kasaFilterBtn.addEventListener('click', function () {
            kasaSearch.focus();
        });
    }

    const kasaExportBtn = document.getElementById('kasaExportBtn');
    if (kasaExportBtn) {
        kasaExportBtn.addEventListener('click', function () {
            const table = document.querySelector('table');
            const rows = Array.from(table.querySelectorAll('thead tr, tbody tr:not(.empty-row)'));
            const csvContent = rows.map(row => {
                const cells = Array.from(row.querySelectorAll('th, td'));
                const rowData = cells.slice(0, -1).map(cell => {
                    let text = cell.innerText.replace(/[\n\r]+/g, ' ').trim();
                    text = text.replace(/"/g, '""');
                    return `"${text}"`;
                });
                return rowData.join(',');
            }).join('\n');
            const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', 'kasa_hareketleri.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });
    }
</script>
{% endblock %}