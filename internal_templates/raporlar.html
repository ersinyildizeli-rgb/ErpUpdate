{% extends 'base.html' %}

{% block content %}
<div class="flex flex-col gap-8 pb-20">
  <!-- Header -->
  <div class="flex flex-col md:flex-row md:items-center justify-between gap-6">
    <div class="flex flex-col gap-1">
      <h1 class="text-3xl font-black text-slate-900 tracking-tight uppercase">İş Zekası & Gelişmiş Raporlar</h1>
      <p class="text-slate-500 text-sm font-medium">Veriye dayalı analizler ve ticari performans göstergeleri.</p>
    </div>
    <div class="flex items-center gap-3">
      <button onclick="window.print()"
        class="flex items-center justify-center gap-2 bg-slate-900 text-white font-bold py-3 px-6 rounded-xl shadow-lg transition-all active:scale-95">
        <span class="material-symbols-outlined text-[20px]">print</span>
        <span>Raporu PDF Kaydet</span>
      </button>
    </div>
  </div>

  <!-- Top KPI Cards -->
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
    <div class="bg-white p-6 rounded-3xl border border-slate-200 shadow-sm overflow-hidden relative">
      <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Toplam Satış (Ciro)</p>
      <h3 class="text-2xl font-black text-emerald-600 tabular-nums">₺{{ '{:,.2f}'.format(bi.total_sales) }}</h3>
      <div class="absolute -right-4 -bottom-4 size-20 bg-emerald-500/5 rounded-full blur-2xl"></div>
    </div>
    <div class="bg-white p-6 rounded-3xl border border-slate-200 shadow-sm overflow-hidden relative">
      <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Toplam Alış (Maliyet)</p>
      <h3 class="text-2xl font-black text-rose-600 tabular-nums">₺{{ '{:,.2f}'.format(bi.total_purchases) }}</h3>
      <div class="absolute -right-4 -bottom-4 size-20 bg-rose-500/5 rounded-full blur-2xl"></div>
    </div>
    <div class="bg-slate-900 p-6 rounded-3xl shadow-xl overflow-hidden relative text-white">
      <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Stok Değeri (Varlık)</p>
      <h3 class="text-2xl font-black text-emerald-400 tabular-nums">₺{{ '{:,.2f}'.format(bi.stock_valuation) }}</h3>
      <div class="absolute -right-4 -bottom-4 size-20 bg-emerald-400/10 rounded-full blur-2xl"></div>
    </div>
    <div class="bg-white p-6 rounded-3xl border border-slate-200 shadow-sm overflow-hidden relative">
      <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Kâr Marjı (Tahmini)</p>
      {% set margin = (bi.gross_profit / bi.total_sales * 100) if bi.total_sales > 0 else 0 %}
      <h3 class="text-2xl font-black text-slate-900 tabular-nums">%{{ '{:,.1f}'.format(margin) }}</h3>
    </div>
  </div>

  <!-- Extended Stats -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
    <div class="bg-indigo-50 border border-indigo-100 p-6 rounded-3xl">
      <p class="text-[10px] font-black text-indigo-400 uppercase tracking-widest mb-1">Toplam Varlıklar (Likidite)</p>
      <h3 class="text-xl font-black text-indigo-900">₺{{ '{:,.2f}'.format(bi.total_assets) }}</h3>
      <p class="text-[9px] text-indigo-400 mt-2 font-bold">Kasa + Banka + Alacaklar + Çekler</p>
    </div>
    <div class="bg-rose-50 border border-rose-100 p-6 rounded-3xl">
      <p class="text-[10px] font-black text-rose-400 uppercase tracking-widest mb-1">Toplam Yükümlülükler</p>
      <h3 class="text-xl font-black text-rose-900">₺{{ '{:,.2f}'.format(bi.total_liabilities) }}</h3>
      <p class="text-[9px] text-rose-400 mt-2 font-bold">Borçlar + Verilen Çekler</p>
    </div>
    <div class="bg-emerald-50 border border-emerald-100 p-6 rounded-3xl">
      <p class="text-[10px] font-black text-emerald-400 uppercase tracking-widest mb-1">Net Finansal Durum</p>
      <h3 class="text-xl font-black text-emerald-900">₺{{ '{:,.2f}'.format(bi.total_assets - bi.total_liabilities) }}
      </h3>
      <p class="text-[9px] text-emerald-400 mt-2 font-bold">Özkaynak Benzeri Likidite</p>
    </div>
  </div>

  <!-- Main Chart Section -->
  <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
    <div class="lg:col-span-8 bg-white p-8 rounded-3xl border border-slate-200 shadow-sm">
      <div class="flex items-center justify-between mb-8">
        <h3 class="text-lg font-black text-slate-900 uppercase tracking-tight">Yıllık Ticari Trend</h3>
        <div class="flex gap-4">
          <div class="flex items-center gap-2 text-[10px] font-black uppercase text-slate-500">
            <span class="size-3 rounded-md bg-emerald-500"></span> Satışlar
          </div>
          <div class="flex items-center gap-2 text-[10px] font-black uppercase text-slate-500">
            <span class="size-3 rounded-md bg-rose-500"></span> Alışlar
          </div>
        </div>
      </div>
      <div class="h-[350px]">
        <canvas id="biTrendChart"></canvas>
      </div>
    </div>

    <!-- Top Rankings -->
    <div class="lg:col-span-4 flex flex-col gap-8">
      <!-- Top Products -->
      <div class="bg-white p-8 rounded-3xl border border-slate-200 shadow-sm">
        <h3 class="text-sm font-black text-slate-900 uppercase tracking-widest mb-6">En Çok Satan Ürünler</h3>
        <div class="flex flex-col gap-4">
          {% for p in bi.top_products %}
          <div class="flex items-center justify-between p-4 rounded-2xl bg-slate-50 border border-slate-100">
            <div class="flex flex-col">
              <span class="text-xs font-black text-slate-800 uppercase truncate max-w-[120px]">{{ p.UrunAdi }}</span>
              <span class="text-[10px] text-slate-500 font-bold uppercase">{{ p.toplam_miktar }} Adet Satıldı</span>
            </div>
            <span class="text-xs font-black text-emerald-600 tabular-nums">₺{{ '{:,.0f}'.format(p.toplam_tutar)
              }}</span>
          </div>
          {% else %}
          <p class="text-xs text-slate-400 italic">Henüz satış verisi yok.</p>
          {% endfor %}
        </div>
      </div>

      <!-- Top Customers -->
      <div class="bg-white p-8 rounded-3xl border border-slate-200 shadow-sm">
        <h3 class="text-sm font-black text-slate-900 uppercase tracking-widest mb-6">En Değerli Müşteriler</h3>
        <div class="flex flex-col gap-4">
          {% for c in bi.top_customers %}
          <div class="flex items-center justify-between p-4 rounded-2xl bg-slate-50 border border-slate-100">
            <span class="text-xs font-black text-slate-800 uppercase truncate max-w-[150px]">{{ c.Unvan }}</span>
            <span class="text-xs font-black text-primary tabular-nums">₺{{ '{:,.0f}'.format(c.toplam_tutar) }}</span>
          </div>
          {% else %}
          <p class="text-xs text-slate-400 italic">Henüz işlem verisi yok.</p>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const biData = {{ bi.chart | tojson }};

  const ctx = document.getElementById('biTrendChart').getContext('2d');
  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: biData.labels,
      datasets: [
        {
          label: 'Satışlar',
          data: biData.sales,
          backgroundColor: '#10b981',
          borderRadius: 8,
          barThickness: 12,
        },
        {
          label: 'Alışlar',
          data: biData.purchases,
          backgroundColor: '#f43f5e',
          borderRadius: 8,
          barThickness: 12,
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: {
          backgroundColor: '#0f172a',
          padding: 15,
          titleFont: { size: 14, weight: 'bold' },
          callbacks: {
            label: function (context) {
              return context.dataset.label + ': ₺' + new Intl.NumberFormat('tr-TR').format(context.parsed.y);
            }
          }
        }
      },
      scales: {
        y: {
          grid: { color: 'rgba(0,0,0,0.05)', drawBorder: false },
          ticks: {
            callback: function (value) { return '₺' + (value / 1000) + 'k'; },
            font: { size: 10, weight: 'bold' }
          }
        },
        x: {
          grid: { display: false }
        }
      }
    }
  });
</script>
{% endblock %}